<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tambola Admin - Game Room</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@latest/dist/full.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .flex-grow { flex-grow: 1; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .drawer-side > *:not(label) { overflow-y: auto; }
        .number-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 0.5rem;
            max-width: 800px;
            margin: auto;
        }
        .number-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1 / 1;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: bold;
            transition: background-color 0.3s, color 0.3s, transform 0.3s, box-shadow 0.3s;
        }
        .number-cell.called {
            background-color: oklch(var(--p));
            color: oklch(var(--pc));
            transform: scale(1.1);
            box-shadow: 0 0 10px oklch(var(--p));
        }
        .number-cell.latest { animation: pulse 1s infinite; }
        @keyframes pulse {
            0% { transform: scale(1.1); box-shadow: 0 0 10px oklch(var(--p)); }
            50% { transform: scale(1.25); box-shadow: 0 0 18px oklch(var(--p)); }
            100% { transform: scale(1.1); box-shadow: 0 0 10px oklch(var(--p)); }
        }
        .bottom-nav-controls-container {
            position: fixed; bottom: 0; left: 0; right: 0;
            background-color: oklch(var(--b1));
            padding: 0.5rem; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 45; display: flex; flex-direction: column; gap: 0.5rem;
            border-top: 1px solid oklch(var(--b3));
        }
        .control-bar {
            display: flex; flex-wrap: wrap; gap: 0.5rem;
            align-items: center; justify-content: space-around;
            width: 100%; padding: 0.25rem 0;
        }
        .control-bar:not(:last-child) {
            border-bottom: 1px solid oklch(var(--b3));
            padding-bottom: 0.75rem; margin-bottom: 0.25rem;
        }
        .game-message-popup {
            position: fixed;
            top: 80px; /* Below navbar */
            right: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            font-size: 0.875rem; /* text-sm */
            z-index: 1000; /* High z-index */
            max-width: 300px;
            word-wrap: break-word;
        }
        main[data-bottom-nav-visible="true"] {
            padding-bottom: 140px; /* Adjust based on .bottom-nav-controls-container height */
        }
    </style>
</head>
<body x-data="adminRoom()">
    <div class="drawer lg:drawer-open">
        <input id="my-drawer" type="checkbox" class="drawer-toggle" x-model="isDrawerOpen" />
        <div class="drawer-content flex flex-col bg-base-200">
            <nav class="navbar bg-base-100 shadow-lg sticky top-0 z-30">
                <div class="flex-none">
                    <label for="my-drawer" class="btn btn-square btn-ghost lg:hidden" aria-label="Open menu">
                        <i class="fas fa-bars text-xl"></i>
                    </label>
                </div>
                <div class="flex-1">
                    <a class="btn btn-ghost normal-case text-xl">Tambola Admin Panel</a>
                </div>
                <div class="flex-none">
                     <span class="mr-2 hidden sm:inline">Room ID: <strong x-text="roomId || 'N/A'"></strong></span>
                    <div class="dropdown dropdown-end ml-2">
                        <label tabindex="0" class="btn btn-ghost btn-circle indicator">
                            <i class="fas fa-bell text-xl"></i>
                            <template x-if="notifications.length > 0">
                                <span class="indicator-item badge badge-secondary badge-sm" x-text="notifications.length"></span>
                            </template>
                        </label>
                        <ul tabindex="0" class="menu menu-sm dropdown-content mt-3 z-[50] p-2 shadow bg-base-100 rounded-box w-64 sm:w-80 max-h-96 overflow-y-auto">
                            <template x-if="notifications.length === 0">
                                <li class="p-2 text-center text-sm text-base-content/70">No new notifications</li>
                            </template>
                            <template x-for="notification in notifications" :key="notification.id">
                                <li>
                                    <a @click="handleNotificationClick(notification)" class="whitespace-normal text-xs p-2 hover:bg-base-200">
                                        <div class="flex flex-col w-full">
                                            <div class="font-semibold" x-text="notification.type"></div>
                                            <div class="text-base-content/80" x-text="notification.message"></div>
                                            <div class="text-xs opacity-60 mt-1 self-end" x-text="new Date(notification.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })"></div>
                                        </div>
                                    </a>
                                </li>
                            </template>
                            <template x-if="notifications.length > 0">
                                <div class="divider my-1"></div>
                                <li><a @click="clearAllNotifications()" class="text-xs text-center text-error p-2 hover:bg-error hover:text-error-content">Clear All</a></li>
                            </template>
                        </ul>
                    </div>
                    <div class="dropdown dropdown-end">
                        <label tabindex="0" class="btn btn-ghost btn-circle" aria-label="Theme selector">
                            <i class="fas fa-palette"></i>
                        </label>
                        <ul tabindex="0" class="menu menu-sm dropdown-content mt-3 z-[50] p-2 shadow bg-base-100 rounded-box w-52">
                            <template x-for="theme in themes" :key="theme">
                                <li><a @click="setTheme(theme, $event)" x-text="theme.charAt(0).toUpperCase() + theme.slice(1)"></a></li>
                            </template>
                        </ul>
                    </div>
                     <button @click="logoutAdmin" class="btn btn-ghost btn-circle" aria-label="Logout Admin">
                        <i class="fas fa-sign-out-alt text-xl"></i>
                    </button>
                </div>
            </nav>

            <main class="flex-grow p-4 overflow-y-auto" :data-bottom-nav-visible="currentView === 'home'">
                <div x-show="currentView === 'home'" x-transition>
                    <h2 class="text-2xl font-bold mb-1">Game Room (<span x-text="adminName"></span>)</h2>
                    <div class="mb-3 text-center">Status: <span class="badge badge-lg"
                        :class="{
                            'badge-neutral': gameStatus === 'idle' || gameStatus === 'loading' || gameStatus === 'disconnected',
                            'badge-success': gameStatus === 'running',
                            'badge-warning': gameStatus === 'paused',
                            'badge-error': gameStatus === 'stopped' || gameStatus === 'error'
                        }"
                        x-text="gameStatus"></span>
                    </div>

                    <div class="text-center my-6" x-show="latestCalledNumber !== null">
                        <span class="label-text">Last Called:</span>
                        <div class="badge badge-lg badge-secondary text-2xl p-4" x-text="latestCalledNumber"></div>
                        <div x-show="latestCalledPhrase" class="mt-1 text-sm italic text-accent" x-text="latestCalledPhrase"></div>
                    </div>
                    <div class="text-center my-6" x-show="latestCalledNumber === null && gameStatus === 'running'">
                        <span class="label-text">Game started. Call the first number!</span>
                    </div>
                     <div class="text-center my-6" x-show="gameStatus === 'idle' || gameStatus === 'stopped'">
                        <span class="label-text">Game is not currently running.</span>
                    </div>

                    <div class="number-grid p-2 bg-base-100 rounded-lg shadow">
                        <template x-for="numObj in numbers" :key="numObj.number">
                            <div class="number-cell" :class="{ 'bg-base-300': !numObj.called, 'called': numObj.called, 'latest': numObj.number === latestCalledNumber && numObj.called }" x-text="numObj.number"></div>
                        </template>
                    </div>
                </div>

                <div x-show="currentView === 'players'" x-transition>
                     <h2 class="text-2xl font-bold mb-4">Players (<span x-text="players.length"></span>)</h2>
                    <div class="overflow-x-auto bg-base-100 p-4 rounded-lg shadow">
                        <table class="table table-zebra w-full table-sm">
                            <thead><tr><th>Name</th><th>ID</th><th class="text-center">Tickets</th></tr></thead>
                            <tbody>
                                <template x-if="players.length === 0"><tr><td colspan="3" class="text-center italic py-4">No players connected yet.</td></tr></template>
                                <template x-for="player in players" :key="player.id">
                                    <tr>
                                        <td x-text="player.name"></td>
                                        <td x-text="player.id" class="text-xs"></td>
                                        <td x-text="player.ticketCount" class="text-center"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div x-show="currentView === 'ticketRequests'" x-transition>
                    <h2 class="text-2xl font-bold mb-4">Pending Ticket Requests (<span x-text="pendingTicketRequests.length"></span>)</h2>
                    <div class="overflow-x-auto bg-base-100 p-4 rounded-lg shadow">
                        <table class="table table-zebra w-full table-sm">
                            <thead>
                                <tr>
                                    <th>Player Name</th>
                                    <th class="text-center">Current Tickets</th>
                                    <th>Timestamp</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-if="pendingTicketRequests.length === 0">
                                    <tr><td colspan="4" class="text-center italic py-4">No pending ticket requests.</td></tr>
                                </template>
                                <template x-for="request in pendingTicketRequests" :key="request.id">
                                    <tr>
                                        <td>
                                            <div class="font-bold" x-text="request.playerName"></div>
                                            <div class="text-xs opacity-70" x-text="'ID: ' + (request.playerId || request.id).substring(0,6)"></div>
                                        </td>
                                        <td class="text-center" x-text="request.currentTickets || 'N/A'"></td>
                                        <td x-text="request.requestTimestamp ? new Date(request.requestTimestamp.seconds * 1000).toLocaleString() : 'N/A'" class="text-xs"></td>
                                        <td class="text-center">
                                            <div class="flex flex-col sm:flex-row gap-1 justify-center items-center">
                                                <button class="btn btn-xs btn-success w-full sm:w-auto" @click="approveTicketRequest(request.id)">Approve</button>
                                                <button class="btn btn-xs btn-error w-full sm:w-auto mt-1 sm:mt-0" @click="rejectTicketRequest(request.id, 'Admin rejected')">Reject</button>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div x-show="currentView === 'prizeClaims'" x-transition>
                     <h2 class="text-2xl font-bold mb-4">Pending Prize Claims (<span x-text="pendingPrizeClaims.length"></span>)</h2>
                    <div class="overflow-x-auto bg-base-100 p-4 rounded-lg shadow">
                        <table class="table table-zebra w-full table-sm">
                            <thead>
                                <tr>
                                    <th>Player</th>
                                    <th>Prize Claimed</th>
                                    <th>Ticket ID</th>
                                    <th class="text-center">Server Valid?</th>
                                    <th>Timestamp</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-if="pendingPrizeClaims.length === 0">
                                    <tr><td colspan="6" class="text-center italic py-4">No pending prize claims.</td></tr>
                                </template>
                                <template x-for="claim in pendingPrizeClaims" :key="claim.id">
                                    <tr>
                                        <td>
                                            <div class="font-bold" x-text="claim.playerName"></div>
                                            <div class="text-xs opacity-70" x-text="'ID: ' + claim.playerId.substring(0,6)"></div>
                                        </td>
                                        <td>
                                            <div x-text="claim.prizeName"></div>
                                            <div class="text-xs opacity-70" x-text="'Rule: ' + claim.prizeRuleId"></div>
                                        </td>
                                        <td class="text-xs" x-text="claim.ticketId ? claim.ticketId.substring(0,10) + '...' : 'N/A'"></td>
                                        <td class="text-center">
                                            <span class="badge badge-sm"
                                                  :class="{'badge-success': claim.serverValidationResult === true, 'badge-warning': claim.serverValidationResult === false, 'badge-ghost': claim.serverValidationResult === undefined}"
                                                  x-text="claim.serverValidationResult === true ? 'Yes' : (claim.serverValidationResult === false ? 'No (Verify)' : 'Pending')">
                                            </span>
                                        </td>
                                        <td x-text="claim.claimTimestamp ? new Date(claim.claimTimestamp.seconds * 1000).toLocaleString() : 'N/A'" class="text-xs"></td>
                                        <td class="text-center">
                                            <div class="flex flex-col sm:flex-row gap-1 justify-center items-center">
                                                <button class="btn btn-xs btn-success w-full sm:w-auto" @click="approvePrizeClaim(claim)">Approve</button>
                                                <button class="btn btn-xs btn-error w-full sm:w-auto mt-1 sm:mt-0" @click="rejectPrizeClaim(claim, 'Did not meet criteria')">Reject</button>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div x-show="currentView === 'winners'" x-transition>
                    <h2 class="text-2xl font-bold mb-4">Winners (<span x-text="winners.length"></span>)</h2>
                     <div class="overflow-x-auto bg-base-100 p-4 rounded-lg shadow">
                        <table class="table table-zebra w-full table-sm">
                            <thead><tr><th>Player</th><th>Prize</th><th>Rule ID</th><th>Value (Coins)</th><th>Time</th></tr></thead>
                            <tbody>
                                <template x-if="winners.length === 0"><tr><td colspan="5" class="text-center italic py-4">No winners yet.</td></tr></template>
                                <template x-for="winner in winners" :key="winner.claimId || winner.id">
                                    <tr>
                                        <td x-text="winner.playerName"></td>
                                        <td x-text="winner.prizeName"></td>
                                        <td x-text="winner.prizeRuleId" class="text-xs"></td>
                                        <td x-text="(winner.coinsAwarded || winner.coins || 0).toFixed(2)"></td>
                                        <td x-text="winner.timestamp ? (winner.timestamp.seconds ? new Date(winner.timestamp.seconds * 1000).toLocaleString() : new Date(winner.timestamp).toLocaleString()) : 'N/A'" class="text-xs"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div x-show="currentView === 'rules'" x-transition class="space-y-6">
                    <h2 class="text-2xl font-bold mb-4">Game Rules & Prize Allocation</h2>
                    <div class="bg-base-100 p-4 rounded-lg shadow">
                        <p class="text-sm mb-4">
                            Activate rules, assign their percentage share (Base Weight) of the total prize pool, and set max prizes.
                            The sum of Base Weights for active rules will always be normalized to 100%. Value per prize is auto-calculated based on the 'Total Money Collected'.
                        </p>
                    </div>
                    <template x-for="(rule, index) in gameRules" :key="rule.id">
                        <div class="card bg-base-100 shadow-md">
                            <div class="card-body p-4">
                                <div class="flex items-center justify-between">
                                    <h3 class="card-title text-lg" x-text="rule.name"></h3>
                                    <input type="checkbox" class="toggle toggle-primary" x-model="rule.isActive" @change="handleActivationToggle(rule.id)" :disabled="gameStatus === 'running' || gameStatus === 'paused'">
                                </div>
                                <p class="text-xs text-base-content/70 mt-1" x-text="rule.description"></p>
                                <div x-show="rule.isActive" class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <div class="form-control">
                                        <label class="label pb-1"><span class="label-text">Base Weight (%)</span></label>
                                        <input type="number" class="input input-sm input-bordered" :value="rule.baseWeight ? rule.baseWeight.toFixed(2) : '0.00'" @input="handleBaseWeightInput(rule.id, $event.target.value)" min="0" max="100" step="0.01" :disabled="gameStatus === 'running' || gameStatus === 'paused'">
                                    </div>
                                    <div class="form-control">
                                        <label class="label pb-1"><span class="label-text">Max Prizes Allowed</span></label>
                                        <input type="number" class="input input-sm input-bordered" x-model.number="rule.maxPrizes" min="1" @input="updateRuleCalculations()" :disabled="gameStatus === 'running' || gameStatus === 'paused'">
                                    </div>
                                    <div class="form-control">
                                        <label class="label pb-1"><span class="label-text">Value per Prize (Coins)</span></label>
                                        <span class="input input-sm input-bordered flex items-center bg-base-200" x-text="rule.coinsPerPrize > 0 ? rule.coinsPerPrize.toFixed(2) : '0.00'"></span>
                                    </div>
                                </div>
                                <div x-show="rule.isActive" class="mt-2 text-sm">Allocated Prize Pool Share: <span class="font-semibold" x-text="rule.baseWeight ? rule.baseWeight.toFixed(2) + '%' : '0.00%'"></span></div>
                            </div>
                        </div>
                    </template>
                    <div class="bg-base-100 p-4 rounded-lg shadow mt-6 space-y-3">
                        <h3 class="text-xl font-semibold">Prize Allocation & Financial Summary</h3>
                        <div class="form-control">
                            <label class="label"><span class="label-text">Total Money Collected (e.g., Coins)</span></label>
                            <input type="number" placeholder="Enter amount" class="input input-bordered" x-model.number="totalMoneyCollected" @input="updateRuleCalculations()" :disabled="gameStatus === 'running' || gameStatus === 'paused'">
                        </div>
                        <p>Total Selected Weight (Active Rules): <strong x-text="totalSelectedWeight.toFixed(0) + '%'"></strong></p>
                        <p>Total Value of Prizes to be Distributed: <strong x-text="totalPotentialPrizeValue.toFixed(2)"></strong> Coins</p>
                        <button class="btn btn-primary btn-sm mt-2" @click="saveRulesConfiguration" :disabled="gameStatus === 'running' || gameStatus === 'paused'">Save Rules & Financials</button>
                         <p x-show="gameStatus === 'running' || gameStatus === 'paused'" class="text-xs text-warning">Rules and financials cannot be saved while game is in progress.</p>
                    </div>
                </div>

                <div x-show="currentView === 'qrCode'" x-transition class="text-center p-4 bg-base-100 rounded-lg shadow">
                    <h2 class="text-2xl font-bold mb-4">Player Join QR Code</h2>
                    <p class="mb-2">Players can scan this QR code to join Room ID: <strong x-text="roomId"></strong></p>
                    <div class="flex justify-center"><div id="qrcodeCanvas" class="bg-white p-4 inline-block rounded-lg shadow-lg"></div></div>
                    <button class="btn btn-secondary mt-4" @click="generateQRCode"><i class="fas fa-sync-alt mr-2"></i>Regenerate QR Code</button>
                </div>

                <div x-show="currentView === 'gameSummary'" x-transition>
                    <h2 class="text-2xl font-bold mb-4">Game Summary</h2>
                    <div x-show="!gameSummaryData || Object.keys(gameSummaryData).length === 0" class="text-center italic p-4 bg-base-100 rounded-lg shadow">
                        Game summary will be available after the game ends or if loaded from Firestore.
                    </div>
                    <div x-show="gameSummaryData && Object.keys(gameSummaryData).length > 0" class="bg-base-100 p-4 rounded-lg shadow space-y-3">
                        <p>Total Numbers Called: <strong x-text="gameSummaryData.totalNumbersCalled !== undefined ? gameSummaryData.totalNumbersCalled : (calledNumbersHistory.length || 'N/A')"></strong></p>
                        <h3 class="text-lg font-semibold mt-4 mb-2">Winners:</h3>
                        <div class="overflow-x-auto">
                            <table class="table table-sm table-zebra w-full">
                                <thead><tr><th>Player</th><th>Prize</th><th>Value (Coins)</th></tr></thead>
                                <tbody>
                                    <template x-if="!gameSummaryData.winners || gameSummaryData.winners.length === 0"><tr><td colspan="3" class="text-center">No winners in this game.</td></tr></template>
                                    <template x-for="winner in gameSummaryData.winners" :key="winner.claimId">
                                        <tr>
                                            <td x-text="winner.playerName"></td>
                                            <td x-text="winner.prizeName"></td>
                                            <td x-text="(winner.coinsAwarded || winner.coins || 0).toFixed(2)"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                         <h3 class="text-lg font-semibold mt-4 mb-2">Player Details (Summary):</h3>
                         <div class="overflow-x-auto">
                            <table class="table table-sm table-zebra w-full">
                                <thead><tr><th>Player</th><th>Tickets</th><th>Total Value Won (Coins)</th></tr></thead>
                                <tbody>
                                    <template x-if="!gameSummaryData.players || gameSummaryData.players.length === 0"><tr><td colspan="3" class="text-center">No player data in summary.</td></tr></template>
                                    <template x-for="playerSummaryItem in gameSummaryData.players" :key="playerSummaryItem.id">
                                        <tr>
                                            <td x-text="playerSummaryItem.name"></td>
                                            <td x-text="playerSummaryItem.ticketCount" class="text-center"></td>
                                            <td x-text="(playerSummaryItem.totalCoinsWon || 0).toFixed(2)"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div x-show="gameMessage" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform translate-y-2" x-transition:enter-end="opacity-100 transform translate-y-0" x-transition:leave="transition ease-in duration-300" x-transition:leave-start="opacity-100 transform translate-y-0" x-transition:leave-end="opacity-0 transform translate-y-2"
                     class="game-message-popup"
                     :class="{ 'bg-error text-error-content': gameMessageType === 'error',
                               'bg-warning text-warning-content': gameMessageType === 'warning',
                               'bg-info text-info-content': gameMessageType === 'info',
                               'bg-success text-success-content': gameMessageType === 'success' }"
                     x-text="gameMessage">
                </div>
            </main>
        </div>

        <div class="drawer-side z-40">
            <label for="my-drawer" aria-label="close sidebar" class="drawer-overlay"></label>
            <ul class="menu p-4 w-80 min-h-full bg-base-100 text-base-content">
                <li class="mb-2 text-center"><span class="text-lg font-bold">Admin Menu</span><button @click="isDrawerOpen = false" class="btn btn-ghost btn-sm btn-circle absolute top-2 right-2 lg:hidden">âœ•</button></li>
                <li><a @click="changeView('home')" :class="{ 'active': currentView === 'home' }"><i class="fas fa-dice-d20 mr-2"></i>Game Board</a></li>
                <li><a @click="changeView('rules')" :class="{ 'active': currentView === 'rules' }"><i class="fas fa-gavel mr-2"></i>Rules & Prizes</a></li>
                <li><a @click="changeView('players')" :class="{ 'active': currentView === 'players' }"><i class="fas fa-users mr-2"></i>Players <span x-show="players.length > 0" class="badge badge-sm" x-text="players.length"></span></a></li>
                <li><a @click="changeView('ticketRequests')" :class="{ 'active': currentView === 'ticketRequests' }"><i class="fas fa-ticket-alt mr-2"></i>Ticket Requests <span x-show="pendingTicketRequests.length > 0" class="badge badge-sm badge-warning" x-text="pendingTicketRequests.length"></span></a></li>
                <li><a @click="changeView('prizeClaims')" :class="{ 'active': currentView === 'prizeClaims' }"><i class="fas fa-trophy mr-2"></i>Prize Claims <span x-show="pendingPrizeClaims.length > 0" class="badge badge-sm badge-info" x-text="pendingPrizeClaims.length"></span></a></li>
                <li><a @click="changeView('winners')" :class="{ 'active': currentView === 'winners' }"><i class="fas fa-medal mr-2"></i>Winners <span x-show="winners.length > 0" class="badge badge-sm badge-success" x-text="winners.length"></span></a></li>
                <li><a @click="changeView('qrCode')" :class="{ 'active': currentView === 'qrCode' }"><i class="fas fa-qrcode mr-2"></i>QR Code</a></li>
                <li><a @click="changeView('gameSummary')" :class="{ 'active': currentView === 'gameSummary' }"><i class="fas fa-clipboard-list mr-2"></i>Game Summary</a></li>
                <li class="mt-auto"><a @click="logoutAdmin()"><i class="fas fa-sign-out-alt mr-2"></i>Logout & New Room Setup</a></li>
            </ul>
        </div>
    </div>

    <div class="bottom-nav-controls-container" x-show="currentView === 'home'">
         <div class="control-bar">
            <div class="form-control">
                <label class="label cursor-pointer py-1">
                    <span class="label-text mr-1 sm:mr-2">Mode:</span>
                    <select class="select select-bordered select-xs sm:select-sm" x-model="callingMode" :disabled="gameStatus === 'running' || gameStatus === 'paused'">
                        <option value="manual">Manual</option>
                        <option value="auto">Auto</option>
                    </select>
                </label>
            </div>
            <div class="form-control" x-show="callingMode === 'auto'">
                <label class="label cursor-pointer py-1">
                    <span class="label-text mr-1 sm:mr-2">Interval:</span>
                    <select class="select select-bordered select-xs sm:select-sm" x-model.number="autoCallInterval" :disabled="gameStatus === 'running' || gameStatus === 'paused'">
                        <option value="3">3s</option>
                        <option value="5">5s</option>
                        <option value="7">7s</option>
                        <option value="10">10s</option>
                         <option value="15">15s</option>
                    </select>
                </label>
            </div>
            <button class="btn btn-success btn-xs sm:btn-sm" @click="startGame" :disabled="gameStatus === 'running' || gameStatus === 'paused' || !roomId">
                <i class="fas fa-play mr-1"></i> Start Game
            </button>
        </div>
        <div class="control-bar">
            <button class="btn btn-primary btn-xs sm:btn-sm" @click="callNextNumber" :disabled="callingMode !== 'manual' || gameStatus !== 'running' || calledNumbersHistory.length >= 90">
                <i class="fas fa-arrow-right mr-1"></i> Call Next
            </button>
            <button class="btn btn-warning btn-xs sm:btn-sm" @click="pauseGame" :disabled="callingMode !== 'auto' || gameStatus !== 'running'">
                <i class="fas fa-pause mr-1"></i> Pause Auto
            </button>
            <button class="btn btn-info btn-xs sm:btn-sm" @click="resumeGame" :disabled="callingMode !== 'auto' || gameStatus !== 'paused'">
                <i class="fas fa-play-circle mr-1"></i> Resume Auto
            </button>
            <button class="btn btn-error btn-xs sm:btn-sm" @click="stopGame" :disabled="gameStatus === 'idle' || gameStatus === 'stopped' || gameStatus === 'loading' || gameStatus === 'error'">
                <i class="fas fa-stop mr-1"></i> Stop Game
            </button>
        </div>
    </div>

    <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-functions-compat.js"></script>

    <script>
      // This script block should execute AFTER the Firebase SDKs have loaded due to 'defer'
      // and also generally after the main DOM is parsed.

      // Firebase Config
      const firebaseConfig = {
        apiKey: "YOUR_API_KEY", // Replace with your actual config
        authDomain: "tambola-premium.firebaseapp.com",
        projectId: "tambola-premium",
        storageBucket: "tambola-premium.firebasestorage.app",
        messagingSenderId: "431036089573",
        appId: "1:431036089573:web:523500fb519d887535800c",
        measurementId: "G-EQHHTY8QKE"
      };

      // Declare global Firebase service variables
      let firebaseAppInstance, fbAuth, fbDb, fbFunctions;

      document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM Loaded. Initializing Firebase explicitly on window...");

        try {
          if (!firebase.apps.length) {
              window.firebaseAppInstance = firebase.initializeApp(firebaseConfig);
          } else {
              window.firebaseAppInstance = firebase.app();
          }
          console.log("Firebase App Initialized on window:", window.firebaseAppInstance);

          window.fbAuth = firebase.auth();
          console.log("Firebase Auth Initialized (window.fbAuth):", typeof window.fbAuth, window.fbAuth);

          window.fbDb = firebase.firestore();
          console.log("Firestore Initialized (window.fbDb):", typeof window.fbDb, window.fbDb);

          if (typeof firebase.functions === 'function') {
              window.fbFunctions = firebase.functions();
              console.log("Firebase Functions Initialized (window.fbFunctions):", typeof window.fbFunctions, window.fbFunctions);
              // Optional: Emulator setup for local testing
              // if (location.hostname === "localhost") {
              //    window.fbDb.useEmulator("localhost", 8080);
              //    window.fbFunctions.useEmulator("localhost", 5001);
              //    window.fbAuth.useEmulator("http://localhost:9099");
              // }
          } else {
              console.error("CRITICAL ERROR: firebase.functions is NOT a function. SDK might not be loaded/initialized.");
              alert("Critical Error: Functions SDK not loaded. Please contact support.");
          }
        } catch (e) {
          console.error("Error during Firebase SDK initialization:", e);
          const mainContent = document.querySelector('main');
          if(mainContent) mainContent.innerHTML = '<div class="p-4 text-center text-error">Critical Error: Firebase could not be initialized. Please refresh or contact support.</div>';
        }
      });


      function adminRoom() {
        console.log("adminRoom component constructor called. Checking window.fbDb:", typeof window.fbDb, "window.fbFunctions:", typeof window.fbFunctions);
        return {
            // Core Admin Info
            adminName: '',
            firebaseAdminUserId: null,
            roomId: '',

            // UI State
            currentView: 'home',
            isDrawerOpen: false,
            themes: [ 
                "light", "dark", "cupcake", "bumblebee", "emerald", "corporate", "synthwave", "retro", "cyberpunk", 
                "valentine", "halloween", "garden", "forest", "aqua", "lofi", "pastel", "fantasy", "wireframe", 
                "black", "luxury", "dracula", "cmyk", "autumn", "business", "acid", "lemonade", "night", "coffee", "winter"
            ],
            notifications: [],

            // Game State
            numbers: [], 
            calledNumbersHistory: [],
            latestCalledNumber: null,
            latestCalledPhrase: '', 
            callingMode: 'manual', 
            autoCallInterval: 5, 
            gameStatus: 'loading', 

            // Data Lists
            players: [], 
            pendingTicketRequests: [], 
            pendingPrizeClaims: [], 
            winners: [], 
            gameSummaryData: {}, 

            // Rules and Financials (default structure, will be overwritten)
            gameRules: [ 
                { id: 'rule_early5', name: 'Early 5', description: 'First five numbers called on any ticket.', baseWeight: 10, maxPrizes: 1, coinsPerPrize: 0, isActive: true, originalWeight: 10, claims: 0 },
                { id: 'rule_topline', name: 'Top Line', description: 'All numbers in the top row.', baseWeight: 15, maxPrizes: 1, coinsPerPrize: 0, isActive: true, originalWeight: 15, claims: 0 },
                { id: 'rule_middleline', name: 'Middle Line', description: 'All numbers in the middle row.', baseWeight: 15, maxPrizes: 1, coinsPerPrize: 0, isActive: true, originalWeight: 15, claims: 0 },
                { id: 'rule_bottomline', name: 'Bottom Line', description: 'All numbers in the bottom row.', baseWeight: 15, maxPrizes: 1, coinsPerPrize: 0, isActive: true, originalWeight: 15, claims: 0 },
                { id: 'rule_corners', name: 'Corners', description: 'First and last actual numbers of top and bottom rows.', baseWeight: 10, maxPrizes: 1, coinsPerPrize: 0, isActive: false, originalWeight: 10, claims: 0 },
                { id: 'rule_fullhouse', name: 'Full House', description: 'All 15 numbers on the ticket.', baseWeight: 35, maxPrizes: 1, coinsPerPrize: 0, isActive: true, originalWeight: 35, claims: 0 },
            ],
            totalSelectedWeight: 0, 
            totalPotentialPrizeValue: 0, 
            totalMoneyCollected: 0, 

            // UI Messages
            gameMessage: '',
            gameMessageType: 'info', 
            gameMessageTimeout: null,

            // Firestore listeners unsubscribe functions
            roomListenerUnsubscribe: null,
            ticketRequestsListenerUnsubscribe: null,
            prizeClaimsListenerUnsubscribe: null,

            init() {
                console.log("adminRoom init() called. Checking window.fbDb:", typeof window.fbDb, "window.fbFunctions:", typeof window.fbFunctions);
                const savedTheme = localStorage.getItem('theme') || 'light'; 
                this.setTheme(savedTheme, null, false); 

                this.adminName = localStorage.getItem('adminName') || 'Admin'; 
                this.roomId = localStorage.getItem('roomId') || null; 
                this.firebaseAdminUserId = localStorage.getItem('firebaseAdminUserId') || null; 

                if (!this.firebaseAdminUserId || !this.roomId) { 
                    this.showGameMessage("Admin session or Room ID missing. Redirecting...", "error", null); 
                    setTimeout(() => { window.location.href = 'admin_join.html'; }, 2500); 
                    return; 
                }
                this.showGameMessage("Loading room data...", "info", null); 
                this.initializeClientStateForNewGame(false); 
                
                this.gameRules.forEach(rule => { 
                    if (rule.originalWeight === undefined) rule.originalWeight = rule.baseWeight !== undefined ? rule.baseWeight : (rule.isActive ? 10 : 0); 
                    if (rule.baseWeight === undefined) rule.baseWeight = (rule.isActive ? 10 :0); 
                    rule.isActive = !!rule.isActive; 
                    rule.maxPrizes = parseInt(rule.maxPrizes) || 1; 
                    rule.coinsPerPrize = parseFloat(rule.coinsPerPrize) || 0; 
                    rule.claims = parseInt(rule.claims) || 0; 
                });
                this.normalizeActiveRuleWeights(); 
                this.updateRuleCalculations(); 

                if (this.roomId) {
                    // Attempt to set up listeners, potentially after a slight delay to ensure SDKs are fully ready
                    // This timeout is primarily for debugging SDK readiness
                    const setupListenersWithCheck = () => {
                        if (typeof window.fbDb === 'object' && window.fbDb.collection) {
                            console.log("DB is ready in init, setting up listeners.");
                            this.setupFirestoreListeners();
                        } else {
                            console.error("DB (window.fbDb) still not ready in init after delay. Type:", typeof window.fbDb, window.fbDb);
                            this.showGameMessage("Error: Critical service (DB) not ready. Please refresh.", "error", null);
                            this.gameStatus = 'error'; 
                        }
                    };
                    // Call it directly if DOMContentLoaded has already fired and SDKs should be ready
                    // Or use a small timeout if issues persist
                    if (document.readyState === "complete" || document.readyState === "interactive") {
                        setupListenersWithCheck();
                    } else {
                         document.addEventListener('DOMContentLoaded', setupListenersWithCheck);
                    }
                }
            },

            initializeClientStateForNewGame(showMsg = true) { /* ... (Keep your existing logic) ... */
                this.numbers = Array.from({ length: 90 }, (_, i) => ({ number: i + 1, called: false }));
                this.calledNumbersHistory = [];
                this.latestCalledNumber = null;
                this.latestCalledPhrase = '';
                this.winners = [];
                this.pendingPrizeClaims = [];
                this.pendingTicketRequests = [];
                this.gameSummaryData = {};
                if (showMsg) {
                    this.showGameMessage("Client state reset (board, history). Waiting for server sync.", "info", 2000);
                }
            },

            setupFirestoreListeners() {
                console.log("setupFirestoreListeners called. Accessing window.fbDb:", typeof window.fbDb);
                if (!this.roomId || !this.firebaseAdminUserId || typeof window.fbDb !== 'object' || !window.fbDb.collection) {
                     console.error("Cannot setup listeners: Room ID, Admin UID, or fbDb not ready.", this.roomId, this.firebaseAdminUserId, typeof window.fbDb);
                     this.showGameMessage("Error: Cannot initialize data listeners. Refresh the page.", "error", null);
                     this.gameStatus = 'error';
                     return;
                }
                const dbInstance = window.fbDb;

                const roomRef = dbInstance.collection('rooms').doc(this.roomId); 
                if (this.roomListenerUnsubscribe) this.roomListenerUnsubscribe(); 
                this.roomListenerUnsubscribe = roomRef.onSnapshot(doc => { /* ... (Your existing room listener logic) ... */
                     if (doc.exists) { 
                        const roomData = doc.data(); 
                        this.gameStatus = roomData.gameStatus || 'idle'; 
                        this.callingMode = roomData.callingMode || 'manual'; 
                        // ... (copy rest of your onSnapshot logic for room)
                        this.calledNumbersHistory = roomData.currentNumbersCalled || []; 
                        this.latestCalledNumber = roomData.currentLatestCalledNumber || null; 
                        this.latestCalledPhrase = roomData.latestCalledPhrase || ''; 

                        this.numbers.forEach(n => n.called = false); 
                        this.calledNumbersHistory.forEach(calledNum => { 
                            const numObj = this.numbers.find(n => n.number === calledNum); 
                            if (numObj) numObj.called = true; 
                        });

                        if (roomData.rules) { 
                            this.gameRules = roomData.rules.map(r => ({ 
                                ...r, 
                                isActive: !!r.isActive, 
                                originalWeight: r.originalWeight !== undefined ? r.originalWeight : (r.baseWeight !== undefined ? r.baseWeight : (!!r.isActive ? 10 : 0)),
                                baseWeight: r.baseWeight !== undefined ? r.baseWeight : (!!r.isActive ? 10 : 0),
                                maxPrizes: parseInt(r.maxPrizes) || 1,
                                coinsPerPrize: parseFloat(r.coinsPerPrize) || 0,
                                claims: parseInt(r.claims) || 0
                            }));
                        }
                        this.totalMoneyCollected = parseFloat(roomData.totalMoneyCollected) || 0; 
                        this.normalizeActiveRuleWeights(); 
                        this.updateRuleCalculations(); 

                        this.players = roomData.currentActivePlayers ? 
                            Object.entries(roomData.currentActivePlayers).map(([uid, playerData]) => ({ 
                                id: uid, name: playerData.playerName, ticketCount: playerData.ticketCount || 0 
                            })) : []; 
                        this.winners = roomData.currentWinners || []; 
                        this.gameSummaryData = roomData.gameSummary || {}; 

                        if(this.gameMessage === "Loading room data..." || this.gameMessage === "Connecting to game room..."){ this.showGameMessage("Room data loaded successfully!", "success", 2000); } 
                    } else { /* ... */ }
                }, error => { /* ... */ });

                const ticketRequestsRef = dbInstance.collection('rooms').doc(this.roomId).collection('ticketRequests')
                    .where('status', '==', 'pending')
                    .orderBy('requestTimestamp', 'desc');
                if (this.ticketRequestsListenerUnsubscribe) this.ticketRequestsListenerUnsubscribe();
                this.ticketRequestsListenerUnsubscribe = ticketRequestsRef.onSnapshot(snapshot => { /* ... (Your existing ticket requests listener logic) ... */
                    const oldRequestCount = this.pendingTicketRequests.length;
                    const requests = []; 
                    snapshot.forEach(doc => requests.push({ id: doc.id, ...doc.data() })); 
                    this.pendingTicketRequests = requests; 
                    if (requests.length > oldRequestCount && oldRequestCount !== undefined && this.gameStatus !== 'loading') { 
                         this.addNotification('Ticket Request', `New ticket request(s) received.`, 'ticketRequests');
                    }
                 });

                 const prizeClaimsRef = dbInstance.collection('prizeClaimsAudit')
                    .where('roomId', '==', this.roomId)
                    .where('status', '==', 'pending_admin_approval') 
                    .orderBy('claimTimestamp', 'desc');
                if (this.prizeClaimsListenerUnsubscribe) this.prizeClaimsListenerUnsubscribe();
                this.prizeClaimsListenerUnsubscribe = prizeClaimsRef.onSnapshot(snapshot => { /* ... (Your existing prize claims listener logic) ... */
                    const oldClaimCount = this.pendingPrizeClaims.length;
                    const claims = []; 
                    snapshot.forEach(doc => claims.push({ id: doc.id, ...doc.data() })); 
                    this.pendingPrizeClaims = claims; 
                    if (claims.length > oldClaimCount && oldClaimCount !== undefined && this.gameStatus !== 'loading') { 
                        this.addNotification('Prize Claim', `New prize claim(s) for approval.`, 'prizeClaims');
                    }
                });
            },

            addNotification(type, message, targetView = null, relatedId = null) { /* ... */ },
            handleNotificationClick(notification) { /* ... */ },
            clearAllNotifications() { /* ... */ },

            async startGame() {
                this.showGameMessage("Attempting to start game...", "info");
                console.log("Inside startGame. Accessing window.fbFunctions:", typeof window.fbFunctions);
                if (typeof window.fbFunctions !== 'object' || typeof window.fbFunctions.httpsCallable !== 'function') {
                    console.error("Error in startGame: 'window.fbFunctions' or '.httpsCallable' is not available.", window.fbFunctions);
                    this.showGameMessage("Client Error: Firebase Functions service is not properly initialized.", "error", null); return;
                }
                const functionsInstance = window.fbFunctions;
                if (this.gameStatus === 'running' || this.gameStatus === 'paused') { /* ... */ return; }
                // ... (rest of your validation)
                try {
                    const startGameFunctionCallable = functionsInstance.httpsCallable('startGame');
                    await startGameFunctionCallable({ /* payload */ });
                    this.showGameMessage("Game start initiated!", "success");
                } catch (error) { /* ... */ }
            },

            async callNextNumber() {
                console.log("Inside callNextNumber. Accessing window.fbFunctions:", typeof window.fbFunctions);
                if (typeof window.fbFunctions !== 'object' || typeof window.fbFunctions.httpsCallable !== 'function') {
                     this.showGameMessage("Client Error: Firebase Functions not ready.", "error"); return;
                }
                const functionsInstance = window.fbFunctions;
                // ... (rest of your validation and logic)
                try {
                    const callNumberFunctionCallable = functionsInstance.httpsCallable('callNextNumber');
                    await callNumberFunctionCallable({ roomId: this.roomId });
                } catch (error) { /* ... */ }
            },

            async updateGameStatusInFirestore(newStatus) {
                console.log("Inside updateGameStatusInFirestore. Accessing window.fbDb:", typeof window.fbDb);
                if (typeof window.fbDb !== 'object' || typeof window.fbDb.collection !== 'function') {
                     this.showGameMessage("Client Error: Firestore not ready.", "error"); return;
                }
                const dbInstance = window.fbDb;
                // ... (rest of your logic)
                try {
                    await dbInstance.collection('rooms').doc(this.roomId).update({ gameStatus: newStatus });
                } catch (error) { /* ... */ }
            },
            pauseGame() { if (this.callingMode === 'auto' && this.gameStatus === 'running') this.updateGameStatusInFirestore('paused'); },
            resumeGame() { if (this.callingMode === 'auto' && this.gameStatus === 'paused') this.updateGameStatusInFirestore('running'); },
            stopGame() { if (this.gameStatus === 'running' || this.gameStatus === 'paused') this.updateGameStatusInFirestore('stopped'); },

            async processTicketRequestAction(requestId, action, reason = null) { // Helper for approve/reject
                console.log(`Inside processTicketRequestAction (${action}). Accessing window.fbFunctions:`, typeof window.fbFunctions);
                if (typeof window.fbFunctions !== 'object' || typeof window.fbFunctions.httpsCallable !== 'function') {
                     this.showGameMessage("Client Error: Firebase Functions not ready.", "error"); return;
                }
                const functionsInstance = window.fbFunctions;
                const request = this.pendingTicketRequests.find(r => r.id === requestId);
                if(!request) { this.showGameMessage("Request not found.", "error"); return; }
                this.showGameMessage(`${action === 'approve' ? 'Approving' : 'Rejecting'} ticket for ${request.playerName}...`, "info");
                try {
                    const processTicketRequestCallable = functionsInstance.httpsCallable('processTicketRequest');
                    await processTicketRequestCallable({ requestId, roomId: this.roomId, action, reason });
                    this.showGameMessage(`Ticket ${action === 'approve' ? 'approval' : 'rejection'} processed.`, "success");
                } catch (error) {
                    console.error(`Error ${action === 'approve' ? 'approving' : 'rejecting'} ticket:`, error);
                    this.showGameMessage(`Failed to ${action} ticket: ${error.message || 'Unknown error'}`, "error");
                }
            },
            approveTicketRequest(requestId) { this.processTicketRequestAction(requestId, 'approve'); },
            rejectTicketRequest(requestId, reason = "Admin rejected") { this.processTicketRequestAction(requestId, 'reject', reason); },

            async processPrizeClaimAction(claim, action, reason = null) { // Helper for approve/reject claim
                console.log(`Inside processPrizeClaimAction (${action}). Accessing window.fbFunctions:`, typeof window.fbFunctions);
                 if (typeof window.fbFunctions !== 'object' || typeof window.fbFunctions.httpsCallable !== 'function') {
                     this.showGameMessage("Client Error: Firebase Functions not ready.", "error"); return;
                }
                const functionsInstance = window.fbFunctions;
                if (!claim || !claim.id) { this.showGameMessage("Invalid claim data.", "error"); return; }
                this.showGameMessage(`${action === 'approve' ? 'Approving' : 'Rejecting'} prize '${claim.prizeName}'...`, "info");
                try {
                    const processPrizeClaimCallable = functionsInstance.httpsCallable('processPrizeClaim');
                    await processPrizeClaimCallable({ claimId: claim.id, roomId: this.roomId, action, reason });
                    this.showGameMessage(`Prize ${action === 'approve' ? 'approval' : 'rejection'} processed.`, "success");
                } catch (error) {
                    console.error(`Error ${action === 'approve' ? 'approving' : 'rejecting'} prize:`, error);
                    this.showGameMessage(`Failed to ${action} prize: ${error.message || 'Unknown error'}`, "error");
                }
            },
            approvePrizeClaim(claim) { this.processPrizeClaimAction(claim, 'approve'); },
            rejectPrizeClaim(claim, reason = "Did not meet criteria") { this.processPrizeClaimAction(claim, 'reject', reason); },
            
            handleActivationToggle(ruleId) { /* ... (Keep your existing logic, ensure it calls normalize & update) ... */ },
            handleBaseWeightInput(ruleId, inputValue) { /* ... (Keep your existing logic, ensure it calls normalize & update) ... */ },
            normalizeActiveRuleWeights(editedRuleId = null, newWeightForEditedRule = null) { /* ... (Keep your existing calculation logic) ... */ },
            updateRuleCalculations() { /* ... (Keep your existing calculation logic) ... */ },

            async saveRulesConfiguration() {
                console.log("Inside saveRulesConfiguration. Accessing window.fbDb:", typeof window.fbDb);
                if (typeof window.fbDb !== 'object' || typeof window.fbDb.collection !== 'function') {
                    this.showGameMessage("Client Error: Firestore not ready.", "error"); return;
                }
                const dbInstance = window.fbDb;
                 if (this.gameStatus === 'running' || this.gameStatus === 'paused') { /* ... */ return; }
                // ... (rest of your logic)
                try {
                    await dbInstance.collection('rooms').doc(this.roomId).update({ /* rules, totalMoneyCollected */ });
                    this.showGameMessage("Rules and financials saved successfully!", "success");
                } catch (error) { /* ... */ }
            },

            setTheme(themeName, event = null, closeDropdown = true) { /* ... (Keep your existing logic) ... */ },
            changeView(viewName) { /* ... (Keep your existing logic) ... */ },
            showGameMessage(text, type = 'info', duration = 3500) { /* ... (Keep your existing logic) ... */ },
            generateQRCode() { /* ... (Keep your existing logic) ... */ },
            
            logoutAdmin() {
                this.showGameMessage("Logging out admin...", "info", 1500);
                if (this.roomListenerUnsubscribe) this.roomListenerUnsubscribe();
                if (this.ticketRequestsListenerUnsubscribe) this.ticketRequestsListenerUnsubscribe();
                if (this.prizeClaimsListenerUnsubscribe) this.prizeClaimsListenerUnsubscribe();

                const authInstance = typeof window.fbAuth !== 'undefined' ? window.fbAuth : (typeof fbAuth !== 'undefined' ? fbAuth : null);
                if (authInstance && typeof authInstance.signOut === 'function') {
                    authInstance.signOut().then(() => {
                        localStorage.removeItem('adminName');
                        localStorage.removeItem('roomId');
                        localStorage.removeItem('firebaseAdminUserId');
                        localStorage.removeItem('firebaseAdminUserEmail');
                        window.location.href = 'admin_join.html';
                    }).catch(error => {
                        console.error("Admin logout error:", error);
                        this.showGameMessage(`Logout failed: ${error.message || 'Unknown error'}`, "error");
                    });
                } else {
                    console.error("Firebase Auth instance (fbAuth) not found or signOut not a function for logout.");
                    // Fallback or simple redirect
                    localStorage.removeItem('adminName'); localStorage.removeItem('roomId');
                    localStorage.removeItem('firebaseAdminUserId'); localStorage.removeItem('firebaseAdminUserEmail');
                    window.location.href = 'admin_join.html';
                }
            }
        };
      }
    </script>
</body>
</html>
