<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tambola Admin - Room Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/antd/4.24.10/antd.min.css" xintegrity="sha512-QAna2V5YCFZWMzCptqsdBfM9gKL3K0tR3jQCk27F/H9FT2Y8oHh07bVjS85jC5eEbK2B3wUoEJNhlLWP13Z20g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ant-design-icons/4.8.0/antd-icons.min.css" xintegrity="sha512-8ev9QLPSSt3Jt5RaGefUT3L2mKnK73sR2OFMIsYfHhIIHd44U8r4YQkH5Sj8kGjLz2JSVNgSb7P9f2Hh9V0n3Q==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial,
                'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol',
                'Noto Color Emoji';
            background-color: #f0f2f5;
            margin: 0;
        }
        #loading-spinner-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.7);
            z-index: 1001; /* Higher than header */
        }
        .admin-layout .ant-layout-header {
            background: #001529;
            padding: 0 24px; /* Adjust padding */
            color: white;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .admin-layout .header-logo {
            font-size: 1.5em;
            font-weight: bold;
            color: white;
        }
        .admin-layout .header-right-menu {
            display: flex;
            align-items: center;
        }
         .admin-layout .ant-layout-sider {
            position: fixed;
            left: 0;
            top: 64px; /* Height of the header */
            height: calc(100% - 64px); /* Adjust based on header height */
            background: #001529;
            overflow: auto;
             z-index: 999;
        }
        .admin-layout .ant-layout-content {
            margin-top: 88px; /* Header height + some padding */
            margin-bottom: 70px; /* Footer height */
            padding: 24px;
            background: #fff;
            min-height: calc(100vh - 64px - 50px - 48px); /* Full height minus header, footer, padding */
        }
        .admin-layout .ant-layout-footer {
            text-align: center;
            background: #001529;
            color: rgba(255,255,255,0.65);
            padding: 15px 50px;
            position: fixed;
            bottom: 0;
            width: 100%;
            z-index: 1000;
        }
        /* Adjust content margin when sider is collapsed/expanded */
        .content-expanded {
            margin-left: 200px; /* Width of expanded sider */
            transition: margin-left 0.2s;
        }
        .content-collapsed {
            margin-left: 80px; /* Width of collapsed sider */
            transition: margin-left 0.2s;
        }
        .form-section-title {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        .rule-item-card {
            margin-bottom: 16px;
            background-color: #fafafa;
        }
        .site-page-header-ghost-wrapper {
            background-color: #f5f5f5; /* Example, adjust as needed */
            padding: 24px;
        }

    </style>
</head>
<body>
    <div id="root">
        </div>
    <div id="loading-spinner-container" style="display: none;"></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/17.0.2/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/17.0.2/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/antd/4.24.10/antd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ant-design-icons/4.8.0/icons.min.js" xintegrity="sha512-/NPat5CqG2gLfn2nkDe+6LKymfsbB9LR3T+RNB5BqZSTZ7aB6uHv9Qd2xES3lVv9j2mXWjRQzClq2Hq7Oq7S7A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


    <script type="text/babel">
        const { useState, useEffect } = React;
        const { Layout, Menu, Breadcrumb, Card, Form, Input, InputNumber, Button, Spin, message, Typography, Space, Radio, Modal, Row, Col, PageHeader, Dropdown } = antd;
        const { Title, Text } = Typography;
        const { SubMenu } = Menu;
        const { UserOutlined, VideoCameraOutlined, UploadOutlined, MenuUnfoldOutlined, MenuFoldOutlined, DashboardOutlined, SettingOutlined, PlusOutlined, DeleteOutlined, LogoutOutlined, DollarCircleOutlined, ClockCircleOutlined, TrophyOutlined, TeamOutlined, BarChartOutlined, FileTextOutlined, ExperimentOutlined } = window.icons || {};

        // --- Firebase Configuration ---
         const firebaseConfig = {
    apiKey: "AIzaSyDeQ3YkvRLvPFnpTPz-aDyh9Yr6JNLqWF0",
    authDomain: "tambola-premium.firebaseapp.com",
    projectId: "tambola-premium",
    storageBucket: "tambola-premium.firebasestorage.app",
    messagingSenderId: "431036089573",
    appId: "1:431036089573:web:523500fb519d887535800c",
    measurementId: "G-EQHHTY8QKE"

        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const functions = firebase.functions();

        const App = () => {
            const [loading, setLoading] = useState(true);
            const [uiLoading, setUiLoading] = useState(false);
            const [user, setUser] = useState(null);
            const [collapsed, setCollapsed] = useState(false);
            const [form] = Form.useForm();

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((currentUser) => {
                    if (currentUser) {
                        setUser(currentUser);
                    } else {
                        // Not signed in, redirect to admin join page
                        window.location.href = 'admin_join.html'; // Relative path
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const handleSignOut = async () => {
                setUiLoading(true);
                try {
                    await auth.signOut();
                    // User will be redirected by onAuthStateChanged
                } catch (error) {
                    message.error(`Sign out failed: ${error.message}`);
                }
                setUiLoading(false);
            };

            const onFinishCreateRoom = async (values) => {
                setUiLoading(true);
                message.loading({ content: 'Creating room...', key: 'createRoom' });
                console.log('Form values for room creation:', values);

                const formattedRules = (values.rules || []).map((rule, index) => ({
                    id: `rule_${Date.now()}_${index}`,
                    name: rule.name,
                    description: rule.description || '',
                    coinsPerPrize: rule.prizeType === 'fixed' ? (rule.prizeAmount || 0) : 0,
                    percentageOfTotal: rule.prizeType === 'percentage' ? (rule.prizePercentage || 0) : 0,
                    maxPrizes: rule.maxWinners || 1,
                    isActive: true,
                }));

                const roomData = {
                    adminDisplayName: values.adminDisplayName,
                    ticketPrice: values.ticketPrice,
                    autoCallInterval: values.autoCallInterval,
                    rules: formattedRules
                };

                try {
                    const createGameRoom = functions.httpsCallable('createGameRoom');
                    const result = await createGameRoom(roomData);
                    message.success({ content: `Room created successfully! Room ID: ${result.data.roomId}`, key: 'createRoom', duration: 5 });
                    form.resetFields();
                } catch (error) {
                    console.error("Error creating game room:", error);
                    message.error({ content: `Failed to create room: ${error.message}`, key: 'createRoom', duration: 5 });
                }
                setUiLoading(false);
            };


            if (loading) {
                document.getElementById('loading-spinner-container').style.display = 'flex';
                ReactDOM.render(<Spin size="large" tip="Loading Admin Portal..." />, document.getElementById('loading-spinner-container'));
                return null;
            } else {
                 document.getElementById('loading-spinner-container').style.display = 'none';
            }

            if (!user) {
                return <div style={{textAlign: 'center', marginTop: '50px'}}><Title level={3}>Redirecting to sign-in...</Title><Spin/></div>;
            }

            const userMenu = (
                <Menu>
                    <Menu.Item key="profile" icon={UserOutlined && <UserOutlined />}>
                        Profile (Coming Soon)
                    </Menu.Item>
                    <Menu.Item key="signOut" onClick={handleSignOut} danger icon={LogoutOutlined && <LogoutOutlined />}>
                        Sign Out
                    </Menu.Item>
                </Menu>
            );


            return (
                <Layout className="admin-layout" style={{ minHeight: '100vh' }}>
                    <Layout.Header>
                        <div className="header-logo">Tambola Admin</div>
                        <div className="header-right-menu">
                            <Text style={{color: 'white', marginRight: '16px'}}>Welcome, {user.email ? user.email.split('@')[0] : 'Admin'}</Text>
                            <Dropdown overlay={userMenu} placement="bottomRight">
                                <Button type="text" style={{color: 'white'}} icon={UserOutlined && <UserOutlined />} />
                            </Dropdown>
                        </div>
                    </Layout.Header>
                    <Layout>
                        <Layout.Sider
                            collapsible
                            collapsed={collapsed}
                            onCollapse={(value) => setCollapsed(value)}
                            breakpoint="lg"
                            collapsedWidth="80"
                            theme="dark"
                            style={{
                                overflow: 'auto',
                                height: '100vh',
                                position: 'fixed',
                                left: 0,
                                top: '64px',
                                bottom: 0,
                                zIndex: 998,
                            }}
                        >
                            <Menu theme="dark" defaultSelectedKeys={['createRoom']} mode="inline">
                                <Menu.Item key="dashboard" icon={DashboardOutlined && <DashboardOutlined />}>
                                    Dashboard
                                </Menu.Item>
                                <Menu.Item key="createRoom" icon={PlusOutlined && <PlusOutlined />}>
                                    Create Room
                                </Menu.Item>
                                <Menu.Item key="manageRooms" icon={SettingOutlined && <SettingOutlined />}>
                                    Manage Rooms
                                </Menu.Item>
                                <SubMenu key="gameplay" icon={TrophyOutlined && <TrophyOutlined />} title="Gameplay">
                                    <Menu.Item key="activeGames">Active Games</Menu.Item>
                                    <Menu.Item key="pastGames">Past Games</Menu.Item>
                                </SubMenu>
                                <Menu.Item key="players" icon={TeamOutlined && <TeamOutlined />}>
                                    Players
                                </Menu.Item>
                                <Menu.Item key="reports" icon={BarChartOutlined && <BarChartOutlined />}>
                                    Reports
                                </Menu.Item>
                                <Menu.Item key="settings" icon={SettingOutlined && <SettingOutlined />}>
                                    Settings
                                </Menu.Item>
                            </Menu>
                        </Layout.Sider>
                        <Layout className={collapsed ? "content-collapsed" : "content-expanded"} style={{ background: '#f0f2f5' }}>
                             <Layout.Content style={{ margin: '88px 16px 70px', padding: 24, background: '#fff', minHeight: 280 }}>
                                <PageHeader
                                    ghost={false}
                                    title="Create New Tambola Game Room"
                                    subTitle="Configure and launch a new game session."
                                />
                                <Card bordered={false}>
                                    <Form
                                        form={form}
                                        layout="vertical"
                                        onFinish={onFinishCreateRoom}
                                        initialValues={{
                                            rules: [{ name: '', description: '', prizeType: 'fixed', prizeAmount: 10, prizePercentage: 10, maxWinners: 1 }],
                                            ticketPrice: 10,
                                            autoCallInterval: 7
                                        }}
                                    >
                                        <Title level={4} className="form-section-title">Basic Room Setup</Title>
                                        <Row gutter={16}>
                                            <Col xs={24} sm={12}>
                                                <Form.Item
                                                    name="adminDisplayName"
                                                    label="Your Admin Display Name"
                                                    rules={[{ required: true, message: 'Please enter your display name for this room!' }]}
                                                >
                                                    <Input placeholder="e.g., Game Master Joe" />
                                                </Form.Item>
                                            </Col>
                                            <Col xs={24} sm={12}>
                                                <Form.Item
                                                    name="ticketPrice"
                                                    label="Ticket Price (Coins/Amount)"
                                                    rules={[{ required: true, type: 'number', min: 0, message: 'Please enter a valid ticket price!' }]}
                                                >
                                                    <InputNumber style={{ width: '100%' }} placeholder="e.g., 10" addonAfter={DollarCircleOutlined && <DollarCircleOutlined />} />
                                                </Form.Item>
                                            </Col>
                                        </Row>
                                        <Form.Item
                                            name="autoCallInterval"
                                            label="Auto-Call Interval (seconds)"
                                            rules={[{ required: true, type: 'number', min: 3, max: 60, message: 'Enter interval (3-60s)' }]}
                                        >
                                            <InputNumber style={{ width: '100%' }} placeholder="e.g., 7" addonAfter={ClockCircleOutlined && <ClockCircleOutlined />} />
                                        </Form.Item>

                                        <Title level={4} className="form-section-title" style={{marginTop: '30px'}}>Game Rules & Prizes</Title>
                                        <Form.List name="rules">
                                            {(fields, { add, remove }) => (
                                                <React.Fragment>
                                                    {fields.map(({ key, name, ...restField }) => (
                                                        <Card key={key} className="rule-item-card" bordered={true} style={{marginBottom: 16}}>
                                                            <Row gutter={16} align="middle">
                                                                <Col flex="auto">
                                                                    <Title level={5}>Rule #{name + 1}</Title>
                                                                </Col>
                                                                <Col>
                                                                    <Button danger type="dashed" onClick={() => remove(name)} icon={DeleteOutlined && <DeleteOutlined />} />
                                                                </Col>
                                                            </Row>
                                                            <Form.Item
                                                                {...restField}
                                                                name={[name, 'name']}
                                                                label="Rule Name"
                                                                rules={[{ required: true, message: 'Missing rule name' }]}
                                                            >
                                                                <Input placeholder="e.g., Full House, Early Five" />
                                                            </Form.Item>
                                                            <Form.Item
                                                                {...restField}
                                                                name={[name, 'description']}
                                                                label="Description (Optional)"
                                                            >
                                                                <Input.TextArea placeholder="Brief description of the rule" rows={2}/>
                                                            </Form.Item>
                                                            <Form.Item
                                                                {...restField}
                                                                name={[name, 'prizeType']}
                                                                label="Prize Type"
                                                                initialValue="fixed"
                                                            >
                                                                <Radio.Group>
                                                                    <Radio value="fixed">Fixed Amount</Radio>
                                                                    <Radio value="percentage">Percentage of Total Pot</Radio>
                                                                </Radio.Group>
                                                            </Form.Item>
                                                            <Form.Item
                                                                noStyle
                                                                shouldUpdate={(prevValues, currentValues) => {
                                                                    const prevRule = prevValues.rules && prevValues.rules[name];
                                                                    const currentRule = currentValues.rules && currentValues.rules[name];
                                                                    const prevPrizeType = prevRule && prevRule.prizeType;
                                                                    const currentPrizeType = currentRule && currentRule.prizeType;
                                                                    return prevPrizeType !== currentPrizeType;
                                                                }}
                                                            >
                                                                {({ getFieldValue }) =>
                                                                    getFieldValue(['rules', name, 'prizeType']) === 'fixed' ? (
                                                                        <Form.Item
                                                                            {...restField}
                                                                            name={[name, 'prizeAmount']}
                                                                            label="Prize Amount (Coins)"
                                                                            rules={[{ required: true, type: 'number', min:0, message: 'Missing prize amount' }]}
                                                                        >
                                                                            <InputNumber style={{ width: '100%' }} placeholder="e.g., 100" />
                                                                        </Form.Item>
                                                                    ) : getFieldValue(['rules', name, 'prizeType']) === 'percentage' ? (
                                                                        <Form.Item
                                                                            {...restField}
                                                                            name={[name, 'prizePercentage']}
                                                                            label="Prize Percentage (%)"
                                                                            rules={[{ required: true, type: 'number', min:1, max:100, message: 'Percentage (1-100)' }]}
                                                                        >
                                                                            <InputNumber style={{ width: '100%' }} placeholder="e.g., 50 for 50%" />
                                                                        </Form.Item>
                                                                    ) : null
                                                                }
                                                            </Form.Item>
                                                            <Form.Item
                                                                {...restField}
                                                                name={[name, 'maxWinners']}
                                                                label="Max Winners for this Prize"
                                                                rules={[{ required: true, type: 'number', min:1, message: 'Min 1 winner' }]}
                                                            >
                                                                <InputNumber style={{ width: '100%' }} placeholder="e.g., 1" />
                                                            </Form.Item>
                                                        </Card>
                                                    ))}
                                                    <Form.Item>
                                                        <Button type="dashed" onClick={() => add({ name: '', description: '', prizeType: 'fixed', prizeAmount: 10, prizePercentage:10, maxWinners: 1 })} block icon={PlusOutlined && <PlusOutlined />}>
                                                            Add Rule
                                                        </Button>
                                                    </Form.Item>
                                                </React.Fragment>
                                            )}
                                        </Form.List>

                                        <Form.Item style={{marginTop: '30px'}}>
                                            <Button type="primary" htmlType="submit" loading={uiLoading} size="large" block icon={ExperimentOutlined && <ExperimentOutlined />}>
                                                Create Game Room
                                            </Button>
                                        </Form.Item>
                                    </Form>
                                </Card>
                            </Layout.Content>
                            <Layout.Footer>
                                Tambola Game Admin Panel ©{new Date().getFullYear()} Created with Ant Design
                            </Layout.Footer>
                        </Layout>
                    </Layout>
                </Layout>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
